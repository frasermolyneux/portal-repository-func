# Copilot Instructions
- **Architecture**: .NET 9 isolated Azure Functions app; startup wiring in [src/XtremeIdiots.Portal.Repository.App/Program.cs](src/XtremeIdiots.Portal.Repository.App/Program.cs) registers Application Insights, health checks, memory cache, and HTTP clients for Repository, Servers Integration, and GeoLocation APIs. Telemetry role name is set in [src/XtremeIdiots.Portal.Repository.App/TelemetryInitializer.cs](src/XtremeIdiots.Portal.Repository.App/TelemetryInitializer.cs). Sampling excludes exceptions in [src/XtremeIdiots.Portal.Repository.App/host.json](src/XtremeIdiots.Portal.Repository.App/host.json).
- **Configuration**: Required settings: `RepositoryApi:BaseUrl`, `RepositoryApi:ApplicationAudience`, `ServersIntegrationApi:BaseUrl`, `ServersIntegrationApi:ApplicationAudience`, `GeoLocationApi:BaseUrl`, `GeoLocationApi:ApiKey`, `GeoLocationApi:ApplicationAudience`, and `xtremeidiots_ftp_certificate_thumbprint` for trusting self-signed FTP certs. Local secrets are supported via user secrets (see `UserSecretsId` in the csproj) and `local.settings.json` is excluded from publish.
- **Health endpoint**: Anonymous GET `/api/health` lives in [src/XtremeIdiots.Portal.Repository.App/Functions/HealthCheck.cs](src/XtremeIdiots.Portal.Repository.App/Functions/HealthCheck.cs) and returns aggregated `HealthCheckService` status.
- **Data maintenance timers**: [DataMaintenance](src/XtremeIdiots.Portal.Repository.App/Functions/DataMaintenance.cs) runs on CRON schedules (hourly/daily) to prune chat messages, game server events/stats, and reset system-assigned player tags. Each task also exposes an `AuthorizationLevel.Function` HTTP trigger for manual invocation.
- **Live server telemetry**: [UpdateLiveStats](src/XtremeIdiots.Portal.Repository.App/Functions/UpdateLiveStats.cs) (every 5 minutes) pulls servers with live tracking enabled, combines RCON + query status, normalizes player names via [Extensions/StringExtensions.cs](src/XtremeIdiots.Portal.Repository.App/Extensions/StringExtensions.cs), enriches IPs with GeoLocation API, writes live players/recent players/admin actions, and updates server live fields. Telemetry emits `PlayerCount` metrics and tracks protected name violations.
- **Map popularity + stats**: [MapPopularity](src/XtremeIdiots.Portal.Repository.App/Functions/MapPopularity.cs) rebuilds map popularity hourly. [SnapshotGameServerStats](src/XtremeIdiots.Portal.Repository.App/Functions/SnapshotGameServerStats.cs) runs every minute to capture player counts and active maps; it caches map existence to avoid duplicate creation.
- **Ban/log file sync**: [UpdateBanFileMonitorConfig](src/XtremeIdiots.Portal.Repository.App/Functions/UpdateBanFileMonitorConfig.cs) and [UpdateLiveLogFile](src/XtremeIdiots.Portal.Repository.App/Functions/UpdateLiveLogFile.cs) run hourly (with manual HTTP triggers) using FluentFTP to inspect server file systems, creating/updating ban monitor records and tracking the most recent log file per server. Trusts FTP certs when the thumbprint matches configuration and records exceptions to Application Insights.
- **Dependencies**: API clients (`XtremeIdiots.Portal.Repository.Api.Client.V1`, `XtremeIdiots.Portal.Integrations.Servers.Api.Client.V1`, `MX.GeoLocation.Api.Client.V1`) are pulled from NuGet and expect OIDC or API key auth configured in settings. RCON/query flows rely on repository data providing host/query ports and `RconPassword`.
- **Local development**: From `src/XtremeIdiots.Portal.Repository.App`, run `dotnet clean`, `dotnet build`, then `dotnet test --filter "FullyQualifiedName!~IntegrationTests"`. Provide required app settings via `local.settings.json` or user secrets; Application Insights is optional for local runs.
- **Patterns**: Use `ILogger.BeginScope` with `TelemetryProperties` from DTOs to tag logs/telemetry per server. Cache player IDs in `IMemoryCache` to minimize repository lookups. When adding new timers, mirror existing `TimerTrigger` cron expressions and provide an HTTP trigger for manual execution when feasible.
- **Deployment workflows**: CI/CD is described in [docs/development-workflows.md](docs/development-workflows.md); main jobs include `build-and-test`, `pr-verify`, `deploy-dev`, and `deploy-prd` with Terraform plan/apply gates. Copilot branches skip plans unless labeled.
